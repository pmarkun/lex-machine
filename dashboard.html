<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lex Dashboard</title>
    <style>

        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            color: white;
        }

        button, input {
            margin: 5pt;
            padding: 20pt;
        }

        #audioInput input, #audioInput button {
            border: solid 1px white;
            background: transparent;
            color: white;
            display: inline-block;
            /* padding: 5pt;
            margin: 0;
            min-height: 25pt; */
        }
        #audioInput input {
            min-width: 450px;
        }

        #chatLog {
            border: solid 1px white;
            padding: 20pt;
            margin: 10pt;
            overflow-y: scroll;
            height: 300pt;
        }

        #continuousButton[value='active'] {
            background: green
        }
        #continuousButton[value='inactive'] {
            background: red
        }


    </style>
</head>
<body>
    <button id="recognitionButton">Reconhecimento</button>
    <button id="pageRefreshButton">Refresh Página</button>
    <button id="contextResetButton">Reset Contexto</button>
    <button id="continuousButton" value="inactive">Conversa Contínua</button>


    <div id="recognitionStatus" class="status"></div>
    <div id="audioStatus" class="status"></div>

    <select name="voiceSelect" id="voiceSelect">
        <!-- <option value="UlbdV3xpXRE93RKCykdn">Voz: Lex</option> -->
        <option value="XB0fDUnXU5powFXDhCwa">Voz: Charlotte</option>
        <option value="XrExE9yKIg1WjnnlVkGX">Voz: Matilda</option>
        <option value="piTKgcLEGmPE4e6mEKli">Voz: Nicole</option>
        <option value="knrPHWnBmmDHMoiMeP3l">Voz: Papai Noel</option>
        <option value="pMsXgVXv3BLzUgSXRplE">Voz: Serena</option>
        <option value="eUtzc6hXtgNdTDPPvaBJ">Voz: Pabblo</option>
    </select>
    <select name="promptSelect" id="promptSelect">
        <option value="default">Default</option>
        <option value="interview">Entrevista</option>
        <option value="picture">Fotografia</option>
        <option value="copycat">Imitador</option>
        <option value="custom">Custom</option>
    </select>

    <textarea name="textPrompt" id="textPrompt">
        Prompt customizado...
    </textarea>

    <div id="audioInput">
        <input type="text" name="text" id="text" />
        <button id="sendTextButton">Send Text</button>
    </div>

    <pre id="chatLog">
        LOG DO CHAT
    </pre>

    <script type="module" src="/static/prompts.js"></script>
    <script>

        let recognitionStatus = null;


        const bc = new BroadcastChannel("activity")
        bc.onmessage = async (event) => {
            console.log('BRODCAST', event);
            switch(event.data.command) {
                case 'chat_update':
                    console.log('CHAT UPDATE', event.data.interactionHistory);
                    document.getElementById('chatLog').innerText = JSON.stringify(event.data.interactionHistory, null, '\t');
                    break;

                case 'recognition_status':
                    recognitionStatus = event.data.status; // active or disabled
                    // TODO: ajustar interface
                    document.getElementById('recognitionStatus').innerText = `Reconhecimento: ${event.data.status}`;
                    document.getElementById('recognitionButton').innerHTML = recognitionStatus === 'active' ? 'Parar Reconhecimento' : 'Iniciar Reconhecimento'
                    break;

                case 'audio_status':
                    document.getElementById('audioStatus').innerText = `Audio: ${event.data.status}`;
                    break;
                
                case 'change_voice':
                    document.getElementById('voiceSelect').value = event.data.voiceId
                    break;
            }
        };


        document.getElementById('recognitionButton').addEventListener('click', async () => {
            console.log('recognitionButton');
            // switch(recognitionStatus) {
            //     case 'active':
            //         break;
            //     default:
            // }
            await (new BroadcastChannel("activity")).postMessage({
                command: 'change_recognition',
                status: recognitionStatus === 'active' ? 'stop' : 'start'
            });
        });
        document.getElementById('pageRefreshButton').addEventListener('click', async () => {
            console.log('pageRefreshButton');
            await (new BroadcastChannel("activity")).postMessage({
                command: 'page_refresh'
            });
        });
        document.getElementById('contextResetButton').addEventListener('click', async () => {
            console.log('contextResetButton');
            await (new BroadcastChannel("activity")).postMessage({
                command: 'context_reset'
            });
        });

        document.getElementById('sendTextButton').addEventListener('click', async () => {
            console.log('sendTextButton');
            await (new BroadcastChannel("activity")).postMessage({
                command: 'play_text',
                text: document.getElementById('text').value
            });
        });

        
        document.getElementById('continuousButton').addEventListener('click', async (e) => {
            console.log('continuousButton');
            e.srcElement.value = e.srcElement.value == 'active' ? 'inactive' : 'active';
            await (new BroadcastChannel("activity")).postMessage({
                command: 'change_continuous',
                continuous: e.srcElement.value == 'active'
            });
        });
        
        document.getElementById('voiceSelect').addEventListener('change', async (e) => {
            console.log('CHANGE VOICE', e.srcElement.value);
            await (new BroadcastChannel("activity")).postMessage({
                command: 'change_voice',
                voiceId: e.srcElement.value
            });
        });
        document.getElementById('promptSelect').addEventListener('change', async (e) => {
            console.log('CHANGE PROMPT', e.srcElement.value);

            let command = {
                command: 'change_prompt',
                promptId: e.srcElement.value
            }
            if (e.srcElement.value == 'custom') {
                if (e.srcElement.value.trim() == '') {
                    return;
                }
                command.prompt = document.getElementById('textPrompt').value;
            }

            await (new BroadcastChannel("activity")).postMessage(command);
        });




    </script>
</body>
</html>